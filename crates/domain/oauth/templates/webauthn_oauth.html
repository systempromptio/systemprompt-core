<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-param name="Expires" content="0">
    <title>systemprompt.io OAuth - Sign In v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'OpenSans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e8e8ed;
        }

        .container {
            background: #12121a;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .logo {
            margin-bottom: 10px;
            text-align: center;
        }

        .logo svg {
            height: 40px;
            width: auto;
        }

        .subtitle {
            color: #9898a6;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .oauth-info {
            background: rgba(249, 115, 22, 0.08);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #f97316;
        }

        .oauth-info h3 {
            color: #e8e8ed;
            margin-bottom: 10px;
            font-size: 16px;
            font-family: 'Zepto', Georgia, serif;
        }

        .oauth-info p {
            color: #9898a6;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .email-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #c2410c;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
            background: #1a1a24;
            color: #e8e8ed;
        }

        .email-input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        .email-input::placeholder {
            color: #9898a6;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: #f97316;
            color: white;
        }

        .btn-primary:hover {
            background: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(249, 115, 22, 0.3);
        }

        .btn-secondary {
            background: #1a1a24;
            color: #e8e8ed;
            border: 2px solid #c2410c;
        }

        .btn-secondary:hover {
            background: #252530;
            border-color: #f97316;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error {
            background: rgba(255, 59, 48, 0.15);
            color: #FF3B30;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #FF3B30;
        }

        .success {
            background: rgba(52, 199, 89, 0.1);
            color: #34C759;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #34C759;
        }

        .spinner {
            border: 2px solid #252530;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .divider {
            margin: 25px 0;
            position: relative;
            color: #9898a6;
            font-size: 14px;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #252530;
        }

        .divider span {
            background: #12121a;
            padding: 0 15px;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="167 461 666 78" height="40">
                <path style="fill:#f79938" d="M 234.109375 461.253906 L 218.292969 516.605469 L 211.96875 538.746094 L 223.039063 538.746094 L 238.859375 483.394531 L 245.179688 461.253906 "/>
                <path style="fill:#f79938" d="M 192.523438 474.636719 L 207.539063 474.636719 L 182.179688 500 L 207.539063 525.359375 L 192.523438 525.359375 L 167.15625 500.007813 "/>
                <path style="fill:#FFFFFF" d="M 285.796875 527.675781 L 252.582031 527.675781 L 252.582031 516.605469 L 274.722656 516.605469 L 274.722656 505.535156 L 252.582031 505.535156 L 252.582031 472.324219 L 285.796875 472.324219 L 285.796875 483.394531 L 263.652344 483.394531 L 263.652344 494.464844 L 285.796875 494.464844 "/>
                <path style="fill:#FFFFFF" d="M 372.359375 472.320313 L 372.359375 483.390625 L 350.21875 483.390625 L 350.21875 494.46875 L 372.359375 494.46875 L 372.359375 527.679688 L 339.148438 527.679688 L 339.148438 516.609375 L 361.289063 516.609375 L 361.289063 505.539063 L 339.148438 505.539063 L 339.148438 472.320313 "/>
                <path style="fill:#FFFFFF" d="M 413.640625 472.320313 L 413.640625 483.390625 L 402.570313 483.390625 L 402.570313 527.679688 L 391.5 527.679688 L 391.5 483.390625 L 380.210938 483.390625 L 380.210938 472.320313 "/>
                <path style="fill:#FFFFFF" d="M 454.925781 527.675781 L 421.714844 527.675781 L 421.714844 472.324219 L 454.925781 472.324219 L 454.925781 483.394531 L 432.785156 483.394531 L 432.785156 494.464844 L 443.855469 494.464844 L 443.855469 505.535156 L 432.785156 505.535156 L 432.785156 516.605469 L 454.925781 516.605469 "/>
                <path style="fill:#FFFFFF" d="M 477.066406 527.675781 L 465.996094 527.675781 L 465.996094 472.324219 L 477.066406 472.324219 L 477.066406 483.394531 L 488.136719 483.394531 L 488.136719 472.324219 L 499.207031 472.324219 L 499.207031 527.675781 L 488.136719 527.675781 L 488.136719 494.464844 L 477.066406 494.464844 "/>
                <path style="fill:#FFFFFF" d="M 521.347656 494.464844 L 532.417969 494.464844 L 532.417969 483.394531 L 521.347656 483.394531 Z M 521.347656 527.675781 L 510.277344 527.675781 L 510.277344 472.324219 L 543.488281 472.324219 L 543.488281 505.535156 L 521.347656 505.535156 "/>
                <path style="fill:#FFFFFF" d="M 609.914063 516.605469 L 620.984375 516.605469 L 620.984375 483.394531 L 609.914063 483.394531 Z M 632.054688 527.675781 L 598.84375 527.675781 L 598.84375 472.324219 L 632.054688 472.324219 Z M 632.054688 527.675781 "/>
                <path style="fill:#FFFFFF" d="M 654.195313 527.675781 L 643.125 527.675781 L 643.125 472.324219 L 654.195313 472.324219 L 654.195313 483.394531 L 665.265625 483.394531 L 665.265625 472.324219 L 676.335938 472.324219 L 676.335938 527.675781 L 665.265625 527.675781 L 665.265625 494.464844 L 654.195313 494.464844 "/>
                <path style="fill:#FFFFFF" d="M 698.480469 494.464844 L 709.550781 494.464844 L 709.550781 483.394531 L 698.480469 483.394531 Z M 698.480469 527.675781 L 687.40625 527.675781 L 687.40625 472.324219 L 720.621094 472.324219 L 720.621094 505.535156 L 698.480469 505.535156 "/>
                <path style="fill:#FFFFFF" d="M 753.832031 527.675781 L 742.761719 527.675781 L 742.761719 483.394531 L 731.691406 483.394531 L 731.691406 472.324219 L 764.902344 472.324219 L 764.902344 483.394531 L 753.832031 483.394531 "/>
                <path style="fill:#FFFFFF" d="M 328.078125 472.324219 L 317.007813 472.324219 L 317.007813 494.464844 L 305.9375 494.464844 L 305.9375 472.324219 L 294.867188 472.324219 L 294.867188 494.464844 L 305.9375 505.535156 L 305.9375 527.675781 L 317.007813 527.675781 L 317.007813 505.535156 L 328.078125 494.464844 "/>
                <path style="fill:#FFFFFF" d="M 587.777344 472.324219 L 554.554688 472.324219 L 554.554688 527.675781 L 565.625 527.675781 L 565.625 516.605469 L 576.695313 527.675781 L 587.777344 527.675781 L 587.777344 516.605469 L 576.695313 505.535156 L 565.625 505.535156 L 565.625 483.394531 L 576.695313 483.394531 L 576.695313 505.535156 L 587.777344 505.535156 "/>
                <path style="fill:#f79938" d="M 766.898438 527.675781 L 776.320313 527.675781 L 776.320313 518.253906 L 766.898438 518.253906 Z M 766.898438 527.675781 "/>
                <path style="fill:#f79938" d="M 785.742188 480.570313 L 795.160156 480.570313 L 795.160156 471.152344 L 785.742188 471.152344 Z M 785.742188 527.675781 L 795.160156 527.675781 L 795.160156 489.992188 L 785.742188 489.992188 Z M 785.742188 527.675781 "/>
                <path style="fill:#f79938" d="M 823.425781 518.253906 L 814.003906 518.253906 L 814.003906 499.414063 L 823.425781 499.414063 Z M 804.582031 527.675781 L 832.84375 527.675781 L 832.84375 489.996094 L 804.582031 489.996094 Z M 804.582031 527.675781 "/>
                <path style="fill:#FFFFFF" d="M 372.359375 483.390625 L 372.359375 472.320313 L 339.148438 472.320313 L 339.148438 505.539063 L 361.289063 505.539063 L 361.289063 516.609375 L 339.148438 516.609375 L 339.148438 527.679688 L 372.359375 527.679688 L 372.359375 494.46875 L 350.21875 494.46875 L 350.21875 483.390625 "/>
            </svg>
        </div>
        <div class="subtitle">Secure Authentication</div>

        <div class="oauth-info">
            <h3>Authorization Request</h3>
            <p><strong>Client:</strong> <span id="client-name">{client_id}</span></p>
            <p><strong>Scopes:</strong> <span id="scopes">{scope}</span></p>
            <input type="hidden" id="oauth-client-id" value="{client_id}">
            <input type="hidden" id="oauth-response-type" value="{response_type}">
            <input type="hidden" id="oauth-redirect-uri" value="{redirect_uri}">
            <input type="hidden" id="oauth-scope" value="{scope}">
            <input type="hidden" id="oauth-state" value="{state}">
            <input type="hidden" id="oauth-code-challenge" value="{code_challenge}">
            <input type="hidden" id="oauth-code-challenge-method" value="{code_challenge_method}">
        </div>

        <div id="error-message" class="error hidden"></div>
        <div id="success-message" class="success hidden"></div>

        <div id="email-section">
            <input type="email" id="email" class="email-input" placeholder="Enter your email address" required>

            <button id="sign-in-btn" class="btn btn-primary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 4"/>
                    <path d="M5 19.5C5.5 18 6 15 6 12c0-.7.12-1.37.34-2"/>
                    <path d="M17.29 21.02c.12-.6.43-2.3.5-3.02"/>
                    <path d="M12 10a2 2 0 0 0-2 2c0 1.02-.1 2.51-.26 4"/>
                    <path d="M8.65 22c.21-.66.45-1.32.57-2"/>
                    <path d="M14 13.12c0 2.38 0 6.38-1 8.88"/>
                    <path d="M2 16h.01"/>
                    <path d="M21.8 16c.2-2 .131-5.354 0-6"/>
                    <path d="M9 6.8a6 6 0 0 1 9 5.2c0 .47 0 1.17-.02 2"/>
                </svg>
                Sign in with Passkey
            </button>

            <div class="divider">
                <span>or</span>
            </div>

            <button id="register-btn" class="btn btn-secondary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                </svg>
                Create New Passkey
            </button>
        </div>

        <div id="loading-section" class="hidden">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Authenticating...</p>
        </div>
    </div>

    <script>
        // Extract OAuth parameters from server-rendered hidden inputs
        const oauthState = {
            response_type: document.getElementById('oauth-response-type').value,
            client_id: document.getElementById('oauth-client-id').value,
            redirect_uri: document.getElementById('oauth-redirect-uri').value,
            scope: document.getElementById('oauth-scope').value,
            state: document.getElementById('oauth-state').value,
            code_challenge: document.getElementById('oauth-code-challenge').value,
            code_challenge_method: document.getElementById('oauth-code-challenge-method').value
        };

        // UI Elements - declare first
        const emailInput = document.getElementById('email');
        const signInBtn = document.getElementById('sign-in-btn');
        const registerBtn = document.getElementById('register-btn');
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        const emailSection = document.getElementById('email-section');
        const loadingSection = document.getElementById('loading-section');

        // Update UI with OAuth info - validate required parameters
        function initializeOAuthForm() {
            if (!oauthState.client_id) {
                document.getElementById('client-name').textContent = 'Missing client_id';
                showError('Missing client_id in authorization request');
                return false;
            }

            if (!oauthState.scope) {
                document.getElementById('scopes').textContent = 'Missing scope';
                showError('Missing scope in authorization request');
                return false;
            }

            document.getElementById('client-name').textContent = oauthState.client_id;
            document.getElementById('scopes').textContent = oauthState.scope;
            return true;
        }

        // Initialize the form
        const isValidOAuth = initializeOAuthForm();

        // Helper functions
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');
        }

        function showSuccess(message) {
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
        }

        function hideMessages() {
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
        }

        function showLoading() {
            emailSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
        }

        function hideLoading() {
            emailSection.classList.remove('hidden');
            loadingSection.classList.add('hidden');
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function base64urlToArrayBuffer(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const padding = '='.repeat((4 - base64.length % 4) % 4);
            const base64Padded = base64 + padding;
            const binary = atob(base64Padded);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function preparePublicKeyCredentialCreationOptions(options) {
            return {
                ...options,
                challenge: base64urlToArrayBuffer(options.challenge),
                user: {
                    ...options.user,
                    id: base64urlToArrayBuffer(options.user.id)
                },
                excludeCredentials: options.excludeCredentials?.map(cred => ({
                    ...cred,
                    id: base64urlToArrayBuffer(cred.id)
                }))
            };
        }

        function preparePublicKeyCredentialRequestOptions(options) {
            return {
                ...options,
                challenge: base64urlToArrayBuffer(options.challenge),
                allowCredentials: options.allowCredentials?.map(cred => ({
                    ...cred,
                    id: base64urlToArrayBuffer(cred.id)
                }))
            };
        }

        async function makeRequest(url, method, body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(url, options);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error_description || data.error || 'Request failed');
            }

            return {
                data,
                challengeId: response.headers.get('x-challenge-id')
            };
        }

        // WebAuthn Registration Flow
        async function registerPasskey() {
            const email = emailInput.value.trim();

            if (!email) {
                showError('Please enter your email address');
                return;
            }

            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }

            try {
                showLoading();
                hideMessages();

                // Start registration
                // Extract username from email (part before @)
                const username = email.split('@')[0];
                const response = await makeRequest(
                    `/api/v1/core/oauth/webauthn/register/start?username=${encodeURIComponent(username)}&email=${encodeURIComponent(email)}`,
                    'POST'
                );

                // Create credential with WebAuthn API
                const publicKeyOptions = preparePublicKeyCredentialCreationOptions(response.data.publicKey);
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyOptions
                });

                if (!credential) {
                    throw new Error('Passkey creation was cancelled');
                }

                // Finish registration
                const finishResponse = await makeRequest('/api/v1/core/oauth/webauthn/register/finish', 'POST', {
                    challenge_id: response.challengeId,
                    username: username,
                    email: email,
                    credential: {
                        id: credential.id,
                        rawId: Array.from(new Uint8Array(credential.rawId)),
                        response: {
                            attestationObject: Array.from(new Uint8Array(credential.response.attestationObject)),
                            clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON))
                        },
                        type: credential.type
                    }
                });

                showSuccess('Passkey created successfully! Redirecting...');

                // Complete OAuth flow - use user_id from registration
                const completeParams = new URLSearchParams();
                completeParams.append('user_id', finishResponse.data.user_id);

                // Pass through OAuth parameters individually
                if (oauthState.response_type) completeParams.append('response_type', oauthState.response_type);
                if (oauthState.client_id) completeParams.append('client_id', oauthState.client_id);
                if (oauthState.redirect_uri) completeParams.append('redirect_uri', oauthState.redirect_uri);
                if (oauthState.scope) completeParams.append('scope', oauthState.scope);
                if (oauthState.state) completeParams.append('state', oauthState.state);
                if (oauthState.code_challenge) completeParams.append('code_challenge', oauthState.code_challenge);
                if (oauthState.code_challenge_method) completeParams.append('code_challenge_method', oauthState.code_challenge_method);

                setTimeout(() => {
                    window.location.href = `/api/v1/core/oauth/webauthn/complete?${completeParams.toString()}`;
                }, 1500);

            } catch (error) {
                hideLoading();
                if (error.name === 'NotAllowedError') {
                    showError('Passkey creation was cancelled or failed');
                } else if (error.name === 'NotSupportedError') {
                    showError('WebAuthn is not supported on this device');
                } else {
                    showError(error.message);
                }
            }
        }

        // WebAuthn Authentication Flow
        async function authenticateUser(email = null) {
            const userEmail = email || emailInput.value.trim();

            if (!userEmail) {
                showError('Please enter your email address');
                return;
            }

            if (!validateEmail(userEmail)) {
                showError('Please enter a valid email address');
                return;
            }

            try {
                showLoading();
                hideMessages();

                // Start authentication with OAuth state
                const authParams = new URLSearchParams({
                    email: userEmail,
                    oauth_state: JSON.stringify(oauthState)
                });

                const startResponse = await makeRequest(
                    `/api/v1/core/oauth/webauthn/auth/start?${authParams}`,
                    'POST'
                );

                // Get credential with WebAuthn API
                const publicKeyOptions = preparePublicKeyCredentialRequestOptions(startResponse.data.publicKey);
                const credential = await navigator.credentials.get({
                    publicKey: publicKeyOptions
                });

                if (!credential) {
                    throw new Error('Authentication was cancelled');
                }

                // Finish authentication
                const finishResponse = await makeRequest('/api/v1/core/oauth/webauthn/auth/finish', 'POST', {
                    challenge_id: startResponse.data.challenge_id,
                    credential: {
                        id: credential.id,
                        rawId: Array.from(new Uint8Array(credential.rawId)),
                        response: {
                            authenticatorData: Array.from(new Uint8Array(credential.response.authenticatorData)),
                            clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON)),
                            signature: Array.from(new Uint8Array(credential.response.signature)),
                            userHandle: credential.response.userHandle ? Array.from(new Uint8Array(credential.response.userHandle)) : null
                        },
                        type: credential.type
                    }
                });

                // Authentication successful - redirect to OAuth completion endpoint
                showSuccess('Authentication successful! Redirecting...');

                // Redirect to WebAuthn completion endpoint with OAuth parameters
                const completeParams = new URLSearchParams();
                completeParams.append('user_id', finishResponse.data.user_id);

                // Pass through OAuth parameters individually
                if (oauthState.response_type) completeParams.append('response_type', oauthState.response_type);
                if (oauthState.client_id) completeParams.append('client_id', oauthState.client_id);
                if (oauthState.redirect_uri) completeParams.append('redirect_uri', oauthState.redirect_uri);
                if (oauthState.scope) completeParams.append('scope', oauthState.scope);
                if (oauthState.state) completeParams.append('state', oauthState.state);
                if (oauthState.code_challenge) completeParams.append('code_challenge', oauthState.code_challenge);
                if (oauthState.code_challenge_method) completeParams.append('code_challenge_method', oauthState.code_challenge_method);

                setTimeout(() => {
                    window.location.href = `/api/v1/core/oauth/webauthn/complete?${completeParams.toString()}`;
                }, 1500);

            } catch (error) {
                hideLoading();
                if (error.name === 'NotAllowedError') {
                    showError('Authentication was cancelled or failed');
                } else if (error.name === 'NotSupportedError') {
                    showError('WebAuthn is not supported on this device');
                } else {
                    showError(error.message || 'Authentication failed');
                }
            }
        }

        // Event listeners - only if OAuth is valid
        if (isValidOAuth) {
            signInBtn.addEventListener('click', () => authenticateUser());
            registerBtn.addEventListener('click', registerPasskey);

            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    authenticateUser();
                }
            });
        }

        // Check WebAuthn support - only if OAuth is valid
        if (isValidOAuth) {
            if (!window.PublicKeyCredential) {
                showError('WebAuthn is not supported on this browser. Please use a modern browser like Chrome, Firefox, or Safari.');
                signInBtn.disabled = true;
                registerBtn.disabled = true;
            }
        }
    </script>
</body>
</html>