<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-param name="Expires" content="0">
    <title>SystemPrompt OAuth - Sign In v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'OpenSans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: hsl(0, 0%, 0%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FFFFFF;
        }

        .container {
            background: #18181b;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .logo {
            margin-bottom: 10px;
            text-align: center;
        }

        .logo svg {
            height: 40px;
            width: auto;
        }

        .subtitle {
            color: #CCCCCC;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .oauth-info {
            background: hsl(28, 91%, 10%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid hsl(28, 91%, 60%);
        }

        .oauth-info h3 {
            color: #FFFFFF;
            margin-bottom: 10px;
            font-size: 16px;
            font-family: 'Zepto', Georgia, serif;
        }

        .oauth-info p {
            color: #CCCCCC;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .email-input {
            width: 100%;
            padding: 15px;
            border: 2px solid hsl(28, 91%, 40%);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
            background: hsl(0, 0%, 15%);
            color: #FFFFFF;
        }

        .email-input:focus {
            outline: none;
            border-color: hsl(28, 91%, 60%);
            box-shadow: 0 0 0 3px rgba(246, 147, 60, 0.2);
        }

        .email-input::placeholder {
            color: #888888;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: hsl(28, 91%, 60%);
            color: white;
        }

        .btn-primary:hover {
            background: hsl(28, 91%, 50%);
            transform: translateY(-2px);
            box-shadow: 0 5px 6.25px rgba(0, 0, 0, 0.5);
        }

        .btn-secondary {
            background: hsl(0, 0%, 15%);
            color: #FFFFFF;
            border: 2px solid hsl(28, 91%, 40%);
        }

        .btn-secondary:hover {
            background: hsl(0, 0%, 20%);
            border-color: hsl(28, 91%, 60%);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error {
            background: rgba(255, 59, 48, 0.15);
            color: #FF3B30;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #FF3B30;
        }

        .success {
            background: rgba(52, 199, 89, 0.1);
            color: #34C759;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #34C759;
        }

        .spinner {
            border: 2px solid hsl(0, 0%, 30%);
            border-top: 2px solid hsl(28, 91%, 60%);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .fingerprint-icon {
            font-size: 20px;
        }

        .divider {
            margin: 25px 0;
            position: relative;
            color: #CCCCCC;
            font-size: 14px;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: hsl(0, 0%, 30%);
        }

        .divider span {
            background: #18181b;
            padding: 0 15px;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="167 461 666 78" height="40">
                <path style="fill:#FB9B34" d="M 234.109375 461.253906 L 218.292969 516.605469 L 211.96875 538.746094 L 223.039063 538.746094 L 238.859375 483.394531 L 245.179688 461.253906 Z"/>
                <path style="fill:#FB9B34" d="M 192.523438 474.636719 L 207.539063 474.636719 L 182.179688 500 L 207.539063 525.359375 L 192.523438 525.359375 L 167.15625 500.007813 Z"/>
                <path style="fill:#FFFFFF" d="M 285.796875 527.675781 L 252.582031 527.675781 L 252.582031 518.515625 L 260.96875 518.515625 L 260.96875 482.929688 L 252.582031 482.929688 L 252.582031 473.324219 L 285.796875 473.324219 L 285.796875 482.929688 L 277.410156 482.929688 L 277.410156 518.515625 L 285.796875 518.515625 Z"/>
                <path style="fill:#FFFFFF" d="M 324.226563 528.449219 C 320.546875 528.449219 317.15625 527.867188 314.058594 526.699219 C 310.957031 525.53125 308.265625 523.847656 305.980469 521.644531 L 311.828125 513.257813 C 313.539063 514.855469 315.5 516.097656 317.710938 516.984375 C 319.917969 517.867188 322.3125 518.308594 324.894531 518.308594 C 327.242188 518.308594 329.097656 517.929688 330.460938 517.171875 C 331.824219 516.410156 332.507813 515.347656 332.507813 513.984375 C 332.507813 512.738281 331.960938 511.730469 330.871094 510.964844 C 329.777344 510.195313 327.695313 509.550781 324.625 509.03125 L 318.578125 508.054688 C 314.472656 507.300781 311.4375 505.890625 309.46875 503.828125 C 307.5 501.765625 306.515625 499.15625 306.515625 496 C 306.515625 493.378906 307.175781 491.054688 308.496094 489.027344 C 309.8125 487 311.710938 485.410156 314.191406 484.257813 C 316.667969 483.105469 319.625 482.527344 323.0625 482.527344 C 326.507813 482.527344 329.601563 483.054688 332.347656 484.109375 C 335.089844 485.164063 337.507813 486.648438 339.601563 488.5625 L 333.753906 496.804688 C 330.152344 493.914063 326.234375 492.46875 322 492.46875 C 319.769531 492.46875 318.050781 492.835938 316.84375 493.574219 C 315.636719 494.3125 315.03125 495.289063 315.03125 496.5 C 315.03125 497.710938 315.535156 498.664063 316.539063 499.359375 C 317.546875 500.058594 319.460938 500.640625 322.289063 501.113281 L 328.339844 502.089844 C 332.640625 502.804688 335.820313 504.175781 337.882813 506.203125 C 339.945313 508.226563 340.976563 510.902344 340.976563 514.230469 C 340.976563 518.179688 339.414063 521.355469 336.289063 523.757813 C 333.164063 526.15625 329.1875 527.894531 324.226563 528.449219 Z"/>
                <path style="fill:#FFFFFF" d="M 374.421875 527.675781 L 357.984375 527.675781 L 357.984375 493.058594 L 349.597656 493.058594 L 349.597656 483.457031 L 382.808594 483.457031 L 382.808594 493.058594 L 374.421875 493.058594 Z"/>
                <path style="fill:#FFFFFF" d="M 418.507813 527.675781 L 401.429688 527.675781 L 401.429688 483.457031 L 435.421875 483.457031 L 435.421875 493.058594 L 417.871094 493.058594 L 417.871094 501.179688 L 433.621094 501.179688 L 433.621094 510.78125 L 417.871094 510.78125 L 417.871094 518.074219 L 435.757813 518.074219 L 435.757813 527.675781 Z"/>
                <path style="fill:#FFFFFF" d="M 488.839844 527.675781 L 488.839844 502.757813 L 478.164063 521.242188 L 470.316406 521.242188 L 459.648438 502.757813 L 459.648438 527.675781 L 443.210938 527.675781 L 443.210938 483.457031 L 459.183594 483.457031 L 474.242188 509.832031 L 489.304688 483.457031 L 505.28125 483.457031 L 505.28125 527.675781 Z"/>
                <path style="fill:#FFFFFF" d="M 526.324219 527.675781 L 526.324219 483.457031 L 548.121094 483.457031 C 552.386719 483.457031 556.027344 484.210938 559.046875 485.71875 C 562.066406 487.222656 564.363281 489.339844 565.933594 492.070313 C 567.503906 494.800781 568.289063 498.023438 568.289063 501.738281 C 568.289063 505.453125 567.476563 508.695313 565.855469 511.464844 C 564.230469 514.230469 561.867188 516.382813 558.761719 517.917969 C 555.660156 519.453125 551.953125 520.222656 547.652344 520.222656 L 542.761719 520.222656 L 542.761719 527.675781 Z M 542.761719 510.621094 L 546.863281 510.621094 C 549.695313 510.621094 551.796875 509.96875 553.160156 508.664063 C 554.523438 507.355469 555.207031 505.492188 555.207031 503.070313 C 555.207031 500.804688 554.566406 499.015625 553.28125 497.707031 C 551.996094 496.402344 549.933594 495.746094 547.101563 495.746094 L 542.761719 495.746094 Z"/>
                <path style="fill:#FFFFFF" d="M 605.632813 527.675781 L 601.53125 518.074219 L 582.65625 518.074219 L 578.554688 527.675781 L 561.917969 527.675781 L 583.652344 483.457031 L 601.15625 483.457031 L 622.890625 527.675781 Z M 592.09375 500.914063 L 586.425781 513.660156 L 597.761719 513.660156 Z"/>
                <path style="fill:#FFFFFF" d="M 659.96875 527.675781 L 642.890625 527.675781 L 642.890625 505.878906 L 626.804688 505.878906 L 626.804688 527.675781 L 609.726563 527.675781 L 609.726563 483.457031 L 626.804688 483.457031 L 626.804688 496.273438 L 642.890625 496.273438 L 642.890625 483.457031 L 659.96875 483.457031 Z"/>
                <path style="fill:#FFFFFF" d="M 682.238281 527.675781 L 665.160156 527.675781 L 665.160156 483.457031 L 682.238281 483.457031 Z"/>
                <path style="fill:#FF9A2F" d="M 766.898438 527.675781 L 776.320313 527.675781 L 776.320313 518.515625 L 766.898438 518.515625 Z M 766.898438 510.78125 L 776.320313 510.78125 L 776.320313 483.457031 L 766.898438 483.457031 Z"/>
                <path style="fill:#FF9A2F" d="M 705.757813 527.675781 L 688.679688 527.675781 L 688.679688 505.878906 C 688.679688 498.851563 690.511719 493.367188 694.179688 489.421875 C 697.84375 485.476563 702.894531 483.503906 709.324219 483.503906 C 715.753906 483.503906 720.8125 485.476563 724.503906 489.421875 C 728.191406 493.367188 730.035156 498.851563 730.035156 505.878906 L 730.035156 527.675781 L 712.957031 527.675781 L 712.957031 506.078125 C 712.957031 503.363281 712.402344 501.328125 711.292969 499.976563 C 710.183594 498.625 708.726563 497.945313 706.921875 497.945313 C 705.195313 497.945313 703.761719 498.632813 702.625 500.003906 C 701.488281 501.378906 700.917969 503.40625 700.917969 506.078125 L 700.917969 527.675781 Z"/>
                <path style="fill:#FF9A2F" d="M 764.527344 505.546875 C 764.527344 500.15625 763.378906 495.410156 761.082031 491.3125 C 758.785156 487.210938 755.523438 484.023438 751.296875 481.746094 C 747.066406 479.46875 742.207031 478.332031 736.71875 478.332031 C 731.230469 478.332031 726.359375 479.476563 722.109375 481.769531 C 717.859375 484.058594 714.582031 487.257813 712.28125 491.359375 C 709.980469 495.464844 708.832031 500.199219 708.832031 505.570313 C 708.832031 510.941406 709.980469 515.667969 712.28125 519.753906 C 714.582031 523.839844 717.863281 527.015625 722.132813 529.285156 C 726.402344 531.550781 731.265625 532.683594 736.71875 532.683594 C 742.171875 532.683594 747.027344 531.539063 751.273438 529.257813 C 755.519531 526.976563 758.789063 523.796875 761.082031 519.730469 C 763.378906 515.664063 764.527344 510.9375 764.527344 505.546875 Z M 747.589844 505.570313 C 747.589844 508.980469 746.617188 511.730469 744.671875 513.824219 C 742.726563 515.917969 740.074219 516.964844 736.71875 516.964844 C 733.363281 516.964844 730.699219 515.929688 728.726563 513.859375 C 726.753906 511.789063 725.769531 509.019531 725.769531 505.546875 C 725.769531 502.117188 726.746094 499.363281 728.703125 497.285156 C 730.660156 495.207031 733.324219 494.167969 736.695313 494.167969 C 740.070313 494.167969 742.734375 495.203125 744.691406 497.273438 C 746.648438 499.34375 747.625 502.105469 747.625 505.554688 Z"/>
            </svg>
        </div>
        <div class="subtitle">Secure Authentication</div>

        <div class="oauth-info">
            <h3>Authorization Request</h3>
            <p><strong>Client:</strong> <span id="client-name">{client_id}</span></p>
            <p><strong>Scopes:</strong> <span id="scopes">{scope}</span></p>
            <input type="hidden" id="oauth-client-id" value="{client_id}">
            <input type="hidden" id="oauth-response-type" value="{response_type}">
            <input type="hidden" id="oauth-redirect-uri" value="{redirect_uri}">
            <input type="hidden" id="oauth-scope" value="{scope}">
            <input type="hidden" id="oauth-state" value="{state}">
            <input type="hidden" id="oauth-code-challenge" value="{code_challenge}">
            <input type="hidden" id="oauth-code-challenge-method" value="{code_challenge_method}">
        </div>

        <div id="error-message" class="error hidden"></div>
        <div id="success-message" class="success hidden"></div>

        <div id="email-section">
            <input type="email" id="email" class="email-input" placeholder="Enter your email address" required>

            <button id="sign-in-btn" class="btn btn-primary">
                <span class="fingerprint-icon">üîê</span>
                Sign in with Passkey
            </button>

            <div class="divider">
                <span>or</span>
            </div>

            <button id="register-btn" class="btn btn-secondary">
                <span>üì±</span>
                Create New Passkey
            </button>
        </div>

        <div id="loading-section" class="hidden">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Authenticating...</p>
        </div>
    </div>

    <script>
        // Extract OAuth parameters from server-rendered hidden inputs
        const oauthState = {
            response_type: document.getElementById('oauth-response-type').value,
            client_id: document.getElementById('oauth-client-id').value,
            redirect_uri: document.getElementById('oauth-redirect-uri').value,
            scope: document.getElementById('oauth-scope').value,
            state: document.getElementById('oauth-state').value,
            code_challenge: document.getElementById('oauth-code-challenge').value,
            code_challenge_method: document.getElementById('oauth-code-challenge-method').value
        };

        // UI Elements - declare first
        const emailInput = document.getElementById('email');
        const signInBtn = document.getElementById('sign-in-btn');
        const registerBtn = document.getElementById('register-btn');
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        const emailSection = document.getElementById('email-section');
        const loadingSection = document.getElementById('loading-section');

        // Update UI with OAuth info - validate required parameters
        function initializeOAuthForm() {
            if (!oauthState.client_id) {
                document.getElementById('client-name').textContent = 'Missing client_id';
                showError('Missing client_id in authorization request');
                return false;
            }

            if (!oauthState.scope) {
                document.getElementById('scopes').textContent = 'Missing scope';
                showError('Missing scope in authorization request');
                return false;
            }

            document.getElementById('client-name').textContent = oauthState.client_id;
            document.getElementById('scopes').textContent = oauthState.scope;
            return true;
        }

        // Initialize the form
        const isValidOAuth = initializeOAuthForm();

        // Helper functions
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');
        }

        function showSuccess(message) {
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');
        }

        function hideMessages() {
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
        }

        function showLoading() {
            emailSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
        }

        function hideLoading() {
            emailSection.classList.remove('hidden');
            loadingSection.classList.add('hidden');
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function base64urlToArrayBuffer(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const padding = '='.repeat((4 - base64.length % 4) % 4);
            const base64Padded = base64 + padding;
            const binary = atob(base64Padded);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function preparePublicKeyCredentialCreationOptions(options) {
            return {
                ...options,
                challenge: base64urlToArrayBuffer(options.challenge),
                user: {
                    ...options.user,
                    id: base64urlToArrayBuffer(options.user.id)
                },
                excludeCredentials: options.excludeCredentials?.map(cred => ({
                    ...cred,
                    id: base64urlToArrayBuffer(cred.id)
                }))
            };
        }

        function preparePublicKeyCredentialRequestOptions(options) {
            return {
                ...options,
                challenge: base64urlToArrayBuffer(options.challenge),
                allowCredentials: options.allowCredentials?.map(cred => ({
                    ...cred,
                    id: base64urlToArrayBuffer(cred.id)
                }))
            };
        }

        async function makeRequest(url, method, body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(url, options);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error_description || data.error || 'Request failed');
            }

            return {
                data,
                challengeId: response.headers.get('x-challenge-id')
            };
        }

        // WebAuthn Registration Flow
        async function registerPasskey() {
            const email = emailInput.value.trim();

            if (!email) {
                showError('Please enter your email address');
                return;
            }

            if (!validateEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }

            try {
                showLoading();
                hideMessages();

                // Start registration
                // Extract username from email (part before @)
                const username = email.split('@')[0];
                const response = await makeRequest(
                    `/api/v1/core/oauth/webauthn/register/start?username=${encodeURIComponent(username)}&email=${encodeURIComponent(email)}`,
                    'POST'
                );

                // Create credential with WebAuthn API
                const publicKeyOptions = preparePublicKeyCredentialCreationOptions(response.data.publicKey);
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyOptions
                });

                if (!credential) {
                    throw new Error('Passkey creation was cancelled');
                }

                // Finish registration
                const finishResponse = await makeRequest('/api/v1/core/oauth/webauthn/register/finish', 'POST', {
                    challenge_id: response.challengeId,
                    username: username,
                    email: email,
                    credential: {
                        id: credential.id,
                        rawId: Array.from(new Uint8Array(credential.rawId)),
                        response: {
                            attestationObject: Array.from(new Uint8Array(credential.response.attestationObject)),
                            clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON))
                        },
                        type: credential.type
                    }
                });

                showSuccess('Passkey created successfully! Redirecting...');

                // Complete OAuth flow - use user_id from registration
                const completeParams = new URLSearchParams();
                completeParams.append('user_id', finishResponse.data.user_id);

                // Pass through OAuth parameters individually
                if (oauthState.response_type) completeParams.append('response_type', oauthState.response_type);
                if (oauthState.client_id) completeParams.append('client_id', oauthState.client_id);
                if (oauthState.redirect_uri) completeParams.append('redirect_uri', oauthState.redirect_uri);
                if (oauthState.scope) completeParams.append('scope', oauthState.scope);
                if (oauthState.state) completeParams.append('state', oauthState.state);
                if (oauthState.code_challenge) completeParams.append('code_challenge', oauthState.code_challenge);
                if (oauthState.code_challenge_method) completeParams.append('code_challenge_method', oauthState.code_challenge_method);

                setTimeout(() => {
                    window.location.href = `/api/v1/core/oauth/webauthn/complete?${completeParams.toString()}`;
                }, 1500);

            } catch (error) {
                hideLoading();
                if (error.name === 'NotAllowedError') {
                    showError('Passkey creation was cancelled or failed');
                } else if (error.name === 'NotSupportedError') {
                    showError('WebAuthn is not supported on this device');
                } else {
                    showError(error.message);
                }
            }
        }

        // WebAuthn Authentication Flow
        async function authenticateUser(email = null) {
            const userEmail = email || emailInput.value.trim();

            if (!userEmail) {
                showError('Please enter your email address');
                return;
            }

            if (!validateEmail(userEmail)) {
                showError('Please enter a valid email address');
                return;
            }

            try {
                showLoading();
                hideMessages();

                // Start authentication with OAuth state
                const authParams = new URLSearchParams({
                    email: userEmail,
                    oauth_state: JSON.stringify(oauthState)
                });

                const startResponse = await makeRequest(
                    `/api/v1/core/oauth/webauthn/auth/start?${authParams}`,
                    'POST'
                );

                // Get credential with WebAuthn API
                const publicKeyOptions = preparePublicKeyCredentialRequestOptions(startResponse.data.publicKey);
                const credential = await navigator.credentials.get({
                    publicKey: publicKeyOptions
                });

                if (!credential) {
                    throw new Error('Authentication was cancelled');
                }

                // Finish authentication
                const finishResponse = await makeRequest('/api/v1/core/oauth/webauthn/auth/finish', 'POST', {
                    challenge_id: startResponse.data.challenge_id,
                    credential: {
                        id: credential.id,
                        rawId: Array.from(new Uint8Array(credential.rawId)),
                        response: {
                            authenticatorData: Array.from(new Uint8Array(credential.response.authenticatorData)),
                            clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON)),
                            signature: Array.from(new Uint8Array(credential.response.signature)),
                            userHandle: credential.response.userHandle ? Array.from(new Uint8Array(credential.response.userHandle)) : null
                        },
                        type: credential.type
                    }
                });

                // Authentication successful - redirect to OAuth completion endpoint
                showSuccess('Authentication successful! Redirecting...');

                // Redirect to WebAuthn completion endpoint with OAuth parameters
                const completeParams = new URLSearchParams();
                completeParams.append('user_id', finishResponse.data.user_id);

                // Pass through OAuth parameters individually
                if (oauthState.response_type) completeParams.append('response_type', oauthState.response_type);
                if (oauthState.client_id) completeParams.append('client_id', oauthState.client_id);
                if (oauthState.redirect_uri) completeParams.append('redirect_uri', oauthState.redirect_uri);
                if (oauthState.scope) completeParams.append('scope', oauthState.scope);
                if (oauthState.state) completeParams.append('state', oauthState.state);
                if (oauthState.code_challenge) completeParams.append('code_challenge', oauthState.code_challenge);
                if (oauthState.code_challenge_method) completeParams.append('code_challenge_method', oauthState.code_challenge_method);

                setTimeout(() => {
                    window.location.href = `/api/v1/core/oauth/webauthn/complete?${completeParams.toString()}`;
                }, 1500);

            } catch (error) {
                hideLoading();
                if (error.name === 'NotAllowedError') {
                    showError('Authentication was cancelled or failed');
                } else if (error.name === 'NotSupportedError') {
                    showError('WebAuthn is not supported on this device');
                } else {
                    showError(error.message || 'Authentication failed');
                }
            }
        }

        // Event listeners - only if OAuth is valid
        if (isValidOAuth) {
            signInBtn.addEventListener('click', () => authenticateUser());
            registerBtn.addEventListener('click', registerPasskey);

            emailInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    authenticateUser();
                }
            });
        }

        // Check WebAuthn support - only if OAuth is valid
        if (isValidOAuth) {
            if (!window.PublicKeyCredential) {
                showError('WebAuthn is not supported on this browser. Please use a modern browser like Chrome, Firefox, or Safari.');
                signInBtn.disabled = true;
                registerBtn.disabled = true;
            }
        }
    </script>
</body>
</html>